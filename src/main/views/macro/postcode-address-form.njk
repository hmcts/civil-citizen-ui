{% from "govuk/components/select/macro.njk" import govukSelect %}
{% from "./address.njk" import addressForm %}

{% macro postcodeLookupAndAddressForm(t, params) %}

  {# Figure out whether manual address has data or errors #}
  {% set manualHasError = false %}
  {% set manualHasValue = false %}

  {% if params.addressType === 'primaryAddress' and params.party.model.primaryAddress %}
    {% set manualHasValue = true %}
    {% if params.party.hasFieldError('primaryAddress') %}
      {% set manualHasError = true %}
    {% endif %}
  {% endif %}

  {% if params.addressType === 'correspondenceAddress' and params.party.model.correspondenceAddress %}
    {% set manualHasValue = true %}
    {% if params.party.hasFieldError('correspondenceAddress') %}
      {% set manualHasError = true %}
    {% endif %}
  {% endif %}

  {# Decide whether manual form should be initially visible #}
  {% if manualHasValue or manualHasError %}
    {% set manualInitiallyHidden = false %}
  {% else %}
    {% set manualInitiallyHidden = true %}
  {% endif %}

  {# Use classes for styling only; use hidden/aria-* for accessibility #}
  {% set manualClass = manualInitiallyHidden ? 'govuk-visually-hidden address-form' : 'address-form' %}

  {# Unique IDs for toggle + manual container so JS can work reliably #}
  {% set manualToggleId = params.addressType + '-enter-address-manually' %}
  {% set manualContainerId = params.addressType + '-manual-address-container' %}

  <div class="govuk-form-group postcode-container">
    <label class="govuk-label" for="{{ params.addressType + 'Postcode' }}">
      {{ t('COMMON.POSTCODE.UK_POSTCODE') }}
    </label>

    <div class="govuk-visually-hidden govuk-error-message">
      {{ t('ERRORS.ADDRESS_NOT_FOUND') + t('ERRORS.TRY_AGAIN') }}
    </div>

    <input
      id="{{ params.addressType + 'Postcode' }}"
      class="govuk-input govuk-input--width-10 postcode-val"
      title="{{ t('COMMON.POSTCODE.UK_POSTCODE') }}"
      name="{{ params.addressType + 'Postcode' }}"
      type="text"
      autocomplete="postal-code" />

    <button
      type="button"
      class="govuk-button govuk-button--secondary"
      data-module="govuk-button">
      {{ t('COMMON.POSTCODE.FIND_ADDRESS') }}
    </button>

    {{ govukSelect({
      id: params.addressType + 'postcodeAddress',
      name: "addressList",
      classes: 'addressList',
      label: {
        text: t('COMMON.POSTCODE.PICK_ADDRESS'),
        classes: 'govuk-visually-hidden'
      },
      items: [
        {
          value: "",
          disabled: true,
          selected: true,
          text: t('COMMON.POSTCODE.ADDESSES_FOUND')
        }
      ]
    }) }}

    {# "Enter address manually" button:
       - present only when manual form is initially hidden
       - not rendered at all once manual form is active (so it cannot stay in tab order) #}
    {% if manualInitiallyHidden %}
      <div>
        <button
          id="{{ manualToggleId }}"
          type="button"
          class="govuk-link govuk-body govuk-link--no-visited-state"
          aria-controls="{{ manualContainerId }}"
          aria-expanded="false">
        {{ t('COMMON.POSTCODE.MANUAL_ADDRESS') }}
      </button>
    </div>
    {% endif %}

    {# Manual address form container:
       - when hidden: has hidden + aria-hidden="true", so it is not focusable or visible
       - when shown: aria-hidden="false" and no hidden attribute #}
    <div>
      <div
        id="{{ manualContainerId }}"
        class="{{ manualClass }}"
        {% if manualInitiallyHidden %}
          hidden
          aria-hidden="true"
        {% else %}
          aria-hidden="false"
        {% endif %}>
        {{ addressForm(
          t,
          party = params.party,
          addressType = params.addressType,
          addressTitle = params.addressTitle
        ) }}
      </div>
    </div>
  </div>
{% endmacro %}
