{% from "govuk/components/select/macro.njk" import govukSelect %}
{% from "./address.njk" import addressForm %}
{% set govukVisuallyHidden = 'govuk-visually-hidden' %}
{% set govukVisuallyHiddenForAnchor = '' %}
{% macro postcodeLookupAndAddressForm(t,params) %}

  {# keep your original logic untouched #}
  {% if params.addressType === 'primaryAddress' and params.party.model.primaryAddress %}
    {% if params.party.hasFieldError('primaryAddress') %}
      {% set govukVisuallyHidden = '' %}
      {% set govukVisuallyHiddenForAnchor = '' %}
    {% else %}
      {% set govukVisuallyHidden = 'govuk-visually-hidden' %}
      {% set govukVisuallyHiddenForAnchor = 'govuk-visually-hidden' %}
    {% endif %}
  {% endif %}

  {% if params.addressType === 'correspondenceAddress' and params.party.model.correspondenceAddress %}
    {% if params.party.hasFieldError('correspondenceAddress') %}
      {% set govukVisuallyHidden = '' %}
      {% set govukVisuallyHiddenForAnchor = '' %}
    {% else %}
      {% set govukVisuallyHidden = 'govuk-visually-hidden' %}
      {% set govukVisuallyHiddenForAnchor = 'govuk-visually-hidden' %}
    {% endif %}
  {% endif %}

  {# NEW: accessibility-safe hidden states #}
  {% set hideSelect = (govukVisuallyHidden == 'govuk-visually-hidden') %}
  {% set hideAnchor = (govukVisuallyHiddenForAnchor == 'govuk-visually-hidden') %}
  {% set hideForm = (govukVisuallyHidden == 'govuk-visually-hidden') %}

  <div class="govuk-form-group postcode-container">
    <label class="govuk-label" for="{{ params.addressType + "Postcode" }}">
      {{ t('COMMON.POSTCODE.UK_POSTCODE') }}
    </label>

    <div class="govuk-visually-hidden govuk-error-message">
      {{ t('ERRORS.ADDRESS_NOT_FOUND') + t('ERRORS.TRY_AGAIN') }}
    </div>

    <input id="{{ params.addressType + 'Postcode' }}"
           class="govuk-input govuk-input--width-10 postcode-val"
           title="{{ t('COMMON.POSTCODE.UK_POSTCODE') }}"
           name="{{ params.addressType + 'Postcode' }}"
           type="text"
           autocomplete="postal-code"/>

    <button href="#" class="govuk-button govuk-button--secondary" data-module="govuk-button">
      {{ t('COMMON.POSTCODE.FIND_ADDRESS') }}
    </button>

    {# -------- ADDRESS SELECT DROPDOWN -------- #}
    <div
      {% if hideSelect %} hidden aria-hidden="true" style="display:none"{% endif %}
    >
      {{ govukSelect({
        id: params.addressType + 'postcodeAddress',
        name: "addressList",
        classes: 'addressList',
        label: {
          text: t('COMMON.POSTCODE.PICK_ADDRESS'),
          classes: 'govuk-visually-hidden'
        },
        items: [
          {
            value: "",
            disabled: true,
            selected: true,
            text: t('COMMON.POSTCODE.ADDESSES_FOUND')
          }
        ]
      }) }}
    </div>

    {# -------- ENTER ADDRESS MANUALLY LINK (RESTORED) -------- #}
    <div
      {% if hideAnchor %} hidden aria-hidden="true" style="display:none"{% endif %}
    >
      <a aria-controls="enterAddressManually"
         href="#"
         class="govuk-body govuk-link">
        {{ t('COMMON.POSTCODE.MANUAL_ADDRESS') }}
      </a>
    </div>

    {# -------- MANUAL ADDRESS FORM -------- #}
    <div>
      <div
        class="address-form"
        {% if hideForm %} hidden aria-hidden="true" style="display:none"{% endif %}
      >
        {{ addressForm(
          t,
          party = params.party,
          addressType = params.addressType,
          addressTitle = params.addressTitle
        ) }}
      </div>
    </div>
  </div>
{% endmacro %}
