{% from "govuk/components/select/macro.njk" import govukSelect %}
{% from "./address.njk" import addressForm %}

{% macro postcodeLookupAndAddressForm(t, params) %}

  {% set formShouldShow =
      (params.addressType == 'primaryAddress' and params.party.hasFieldError('primaryAddress'))
      or
      (params.addressType == 'correspondenceAddress' and params.party.hasFieldError('correspondenceAddress'))
  %}

  <div class="govuk-form-group postcode-container">

    <label class="govuk-label" for="{{ params.addressType }}Postcode">
      {{ t('COMMON.POSTCODE.UK_POSTCODE') }}
    </label>

    <div class="govuk-visually-hidden govuk-error-message">
      {{ t('ERRORS.ADDRESS_NOT_FOUND') + t('ERRORS.TRY_AGAIN') }}
    </div>

    <input
      id="{{ params.addressType }}Postcode"
      class="govuk-input govuk-input--width-10 postcode-val"
      name="{{ params.addressType }}Postcode"
      type="text"
      autocomplete="postal-code"
    />

    <button class="govuk-button govuk-button--secondary" data-module="govuk-button">
      {{ t('COMMON.POSTCODE.FIND_ADDRESS') }}
    </button>

    {{ govukSelect({
      id: params.addressType + 'postcodeAddress',
      name: "addressList",
      classes: 'addressList',
      label: {
        text: t('COMMON.POSTCODE.PICK_ADDRESS'),
        classes: 'govuk-visually-hidden'
      },
      items: [
        {
          value: "",
          disabled: true,
          selected: true,
          text: t('COMMON.POSTCODE.ADDESSES_FOUND')
        }
      ]
    }) }}

    {# Manual link #}
    <div
      id="{{ params.addressType }}-manual-link-wrapper"
      {% if formShouldShow %}
        hidden aria-hidden="true"
      {% endif %}
    >
      <a
        id="{{ params.addressType }}-enter-manually"
        href="#"
        class="govuk-body govuk-link"
        {% if formShouldShow %}
          tabindex="-1"
        {% endif %}
        aria-controls="{{ params.addressType }}-manual-address-wrapper"
        data-address-type="{{ params.addressType }}"
      >
        {{ t('COMMON.POSTCODE.MANUAL_ADDRESS') }}
      </a>
    </div>

    {# Manual address form #}
    <div>
      <div
        id="{{ params.addressType }}-manual-address-wrapper"
        class="address-form"
        {% if not formShouldShow %}
          hidden aria-hidden="true"
        {% endif %}
      >
        {{ addressForm(
            t,
            party = params.party,
            addressType = params.addressType,
            addressTitle = params.addressTitle
        ) }}
      </div>
    </div>

    {# Temporary debug visual for testing #}
    <div
      id="{{ params.addressType }}-focus-debug"
      style="display:none; margin-top:8px; padding:6px; background:#fff3cd; color:#856404; border:1px solid #ffeeba; border-radius:4px; font-size:14px;"
    >
      Debug: waiting to focus addressLine1…
    </div>

  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function () {

      const addressType = "{{ params.addressType }}";
      const link       = document.getElementById(addressType + "-enter-manually");
      const linkWrap   = document.getElementById(addressType + "-manual-link-wrapper");
      const formWrap   = document.getElementById(addressType + "-manual-address-wrapper");
      const debugBox   = document.getElementById(addressType + "-focus-debug");

      if (!link || !formWrap) return;

      link.addEventListener("click", function (e) {
        e.preventDefault();

        // SHOW manual address form
        formWrap.hidden = false;
        formWrap.setAttribute("aria-hidden", "false");

        // HIDE link from SR + tab order + UI
        linkWrap.hidden = true;
        linkWrap.setAttribute("aria-hidden", "true");
        link.setAttribute("tabindex", "-1");

        // Show debug visual
        if (debugBox) {
          debugBox.style.display = "block";
          debugBox.textContent = "Debug: focusing addressLine1 in 100ms…";
        }

        // Focus first input after small delay (VoiceOver safe)
        setTimeout(() => {
          const firstInput = formWrap.querySelector("input[id$='addressLine1']");
          if (firstInput) {
            firstInput.focus({ preventScroll: false });
            console.log("DEBUG: Focus moved to", firstInput.id, "at", Date.now());
            if (debugBox) {
              debugBox.textContent = "Debug: Focus moved to " + firstInput.id;
              // hide debug box after 3s
              setTimeout(() => { debugBox.style.display = "none"; }, 3000);
            }
          } else {
            console.warn("DEBUG: addressLine1 input not found!");
            if (debugBox) debugBox.textContent = "DEBUG: addressLine1 input NOT FOUND!";
          }
        }, 100);

      });
    });
  </script>

{% endmacro %}
