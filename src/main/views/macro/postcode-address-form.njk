{% from "govuk/components/select/macro.njk" import govukSelect %}
{% from "./address.njk" import addressForm %}

{% macro postcodeLookupAndAddressForm(t, params) %}

  {# ---------------------------------------------
     DETERMINE IF WE SHOULD SHOW MANUAL ADDRESS FORM
     ---------------------------------------------- #}

  {% set showAddressForm =
      (params.addressType == 'primaryAddress' and params.party.hasFieldError('primaryAddress'))
      or
      (params.addressType == 'correspondenceAddress' and params.party.hasFieldError('correspondenceAddress'))
  %}

  {# Controls if the “Enter manually” link is visible #}
  {% set showManualLink = not showAddressForm %}

  <div class="govuk-form-group postcode-container">

    <label class="govuk-label" for="{{ params.addressType + 'Postcode' }}">
      {{ t('COMMON.POSTCODE.UK_POSTCODE') }}
    </label>

    <div class="govuk-visually-hidden govuk-error-message">
      {{ t('ERRORS.ADDRESS_NOT_FOUND') + t('ERRORS.TRY_AGAIN') }}
    </div>

    <input
      id="{{ params.addressType + 'Postcode' }}"
      class="govuk-input govuk-input--width-10 postcode-val"
      name="{{ params.addressType + 'Postcode' }}"
      type="text"
      autocomplete="postal-code"
    />

    <button class="govuk-button govuk-button--secondary" data-module="govuk-button">
      {{ t('COMMON.POSTCODE.FIND_ADDRESS') }}
    </button>

    {{ govukSelect({
      id: params.addressType + 'postcodeAddress',
      name: "addressList",
      classes: 'addressList',
      label: {
        text: t('COMMON.POSTCODE.PICK_ADDRESS'),
        classes: 'govuk-visually-hidden'
      },
      items: [
        {
          value: "",
          disabled: true,
          selected: true,
          text: t('COMMON.POSTCODE.ADDESSES_FOUND')
        }
      ]
    }) }}

    {# ---------------------------------------------
       ENTER ADDRESS MANUALLY LINK (removed from SR when hidden)
       ---------------------------------------------- #}

    <div
      id="{{ params.addressType }}-manual-link-wrapper"
      {% if not showManualLink %}
        hidden aria-hidden="true"
      {% endif %}
    >
      <a
        id="{{ params.addressType }}-enter-manually"
        href="#"
        class="govuk-body govuk-link"
        {% if not showManualLink %}
          tabindex="-1"
        {% endif %}
        data-address-type="{{ params.addressType }}"
        aria-controls="{{ params.addressType }}-manual-address-wrapper"
      >
        {{ t('COMMON.POSTCODE.MANUAL_ADDRESS') }}
      </a>
    </div>

    {# ---------------------------------------------
       MANUAL ADDRESS FORM (hidden from SR + UI until opened)
       ---------------------------------------------- #}

    <div>
      <div
        id="{{ params.addressType }}-manual-address-wrapper"
        class="address-form"
        {% if not showAddressForm %}
          hidden aria-hidden="true"
        {% endif %}
      >
        {{ addressForm(
            t,
            party = params.party,
            addressType = params.addressType,
            addressTitle = params.addressTitle
        ) }}
      </div>
    </div>

  </div>

  {# ----------------------------------------------------------------
     INLINE ACCESSIBLE JS — FULLY GOV.UK COMPATIBLE AND SCREEN-READER SAFE
     ---------------------------------------------------------------- #}

  <script>
    document.addEventListener("DOMContentLoaded", function () {

      const link = document.getElementById("{{ params.addressType }}-enter-manually");
      if (!link) return;

      const wrapper = document.getElementById("{{ params.addressType }}-manual-address-wrapper");
      const linkWrapper = document.getElementById("{{ params.addressType }}-manual-link-wrapper");

      link.addEventListener("click", function(e) {
        e.preventDefault();

        // SHOW address form
        wrapper.hidden = false;
        wrapper.setAttribute("aria-hidden", "false");

        // REMOVE the enter manually link from SR + UI
        linkWrapper.hidden = true;
        linkWrapper.setAttribute("aria-hidden", "true");

        // Move focus into first address field
        const firstInput = wrapper.querySelector("input[id$='addressLine1']");
        if (firstInput) {
          firstInput.focus({ preventScroll: false });
        }
      });

    });
  </script>

{% endmacro %}
