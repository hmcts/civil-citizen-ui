name: CI

on:
  pull_request:
    branches:
      - master
  push:
    branches:
      - master
      - refs/tags/*
    tags:
      - '*'

env:
  CI: true
  NODE_OPTIONS: --max-old-space-size=4096
  CIVIL_SERVICE_URL: http://localhost:1111
  TEST_URL: http://localhost:3001
  IDAM_API_URL: http://localhost:1111
  CIVIL_GENERAL_APPLICATIONS_URL: http://localhost:1111
  ENVIRONMENT: preview
  LAUNCH_DARKLY_SDK: test

jobs:
  strict-ts-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 21.6.1
      - name: Install dependencies
        run: yarn install
      - name: Build
        run: yarn build
      - name: Get changed TypeScript files
        id: changed
        run: |
          git fetch origin master
          git diff --name-only origin/master -- '*.ts' '*.tsx' > changed-files.txt
          echo "Changed files:"
          cat changed-files.txt
      - name: Run TypeScript with strictNullChecks
        run: |
          yarn tsc --noEmit --strictNullChecks > /dev/null 2> all-errors.txt || true
      - name: Filter errors to changed files
        run: |
          echo "Reading changed files:"
          cat changed-files.txt

          echo "Reading all TypeScript errors:"
          cat all-errors.txt

          echo "Starting error filtering..."
          CHANGED_FILES=$(cat changed-files.txt)
          MATCHED_ERRORS=""
          MATCH_COUNT=0

          while IFS= read -r error_line; do
            echo "Checking error line: $error_line"
            for file in $CHANGED_FILES; do
              if echo "$error_line" | grep -q "^$file"; then
                echo "Matched error for file: $file"
                MATCHED_ERRORS="$MATCHED_ERRORS\n$error_line"
                MATCH_COUNT=$((MATCH_COUNT + 1))
                break
              fi
            done
          done < all-errors.txt

          echo "Total matched errors: $MATCH_COUNT"
          if [ "$MATCH_COUNT" -gt 0 ]; then
            echo -e "$MATCHED_ERRORS" > filtered-errors.txt
            echo "TypeScript errors found in changed files:"
            cat filtered-errors.txt
            exit 1
          else
            echo "No TypeScript errors in changed files."
          fi


  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 21.6.1
      - name: Install
        run: yarn install && yarn playwright install
      - name: Build
        run: yarn build
      - name: Starting WireMock , starting ui , wait and run e2e test
        run: |
          yarn wiremock:start &
          sleep 2
          yarn start:e2e &
          sleep 25
          yarn test:e2e
      - name: Upload e2e test artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: integration-tests-results
          path: |
            test-results/functional
            src/test/functionalTests/test-results
